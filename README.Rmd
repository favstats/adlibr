---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  eval = FALSE
)
```

# liads

<!-- badges: start -->
[![R-CMD-check](https://github.com/favstats/liads/workflows/R-CMD-check/badge.svg)](https://github.com/favstats/liads/actions)
[![CRAN status](https://www.r-pkg.org/badges/version/liads)](https://CRAN.R-project.org/package=liads)
[![Lifecycle: stable](https://img.shields.io/badge/lifecycle-stable-brightgreen.svg)](https://lifecycle.r-lib.org/articles/stages.html#stable)
<!-- badges: end -->

**liads** is a comprehensive R client for the [LinkedIn Ad Library API](https://www.linkedin.com/ad-library/api/ads). It provides tools for OAuth 2.0 authentication, querying ads by various criteria, automatic pagination, and robust data processing.

## Features

- **üîê OAuth 2.0 Authentication**: Complete 3-legged authentication workflow
- **üîç Comprehensive Search**: Query by keyword, advertiser, country, and date range
- **üìä Automatic Pagination**: Handles large result sets automatically
- **üõ°Ô∏è Robust Error Handling**: Graceful handling of API errors and edge cases
- **üìà Rich Data Structure**: Returns structured data with targeting and impression data
- **‚úÖ Full API Coverage**: Supports all parameters from the official LinkedIn API

## Installation

You can install the development version of liads from [GitHub](https://github.com/favstats/liads) with:

``` r
# install.packages("devtools")
devtools::install_github("favstats/liads")
```

## Quick Start

### 1. Authentication Setup

First, set up your LinkedIn Developer App credentials (one-time setup):

```{r setup}
library(liads)

# Configure your LinkedIn app credentials
li_auth_configure()  # You'll be prompted to enter Client ID and Secret

# Authenticate (opens browser for OAuth)
li_auth()
```

### 2. Basic Usage

```{r basic-search}
# Simple keyword search
marketing_ads <- li_query(
  keyword = "marketing",
  max_pages = 1
)
```

The most basic search uses just a keyword. This returns raw data with list-columns for detailed analysis:

```{r basic-results}
print(paste("Found", nrow(marketing_ads), "ads"))
print("Column names:")
print(names(marketing_ads))
```

### Searching by Country

For more targeted results, search within specific countries:

```{r country-search}
us_ads <- li_query(
  countries = c("us"),
  max_pages = 2,
  count = 10
)
```

### Using Clean Data Format

The `clean = TRUE` parameter removes list-columns for easier analysis:

```{r clean-intro}
# Get cleaned data without complex list-columns
clean_ads <- li_query(
  countries = c("us"),
  clean = TRUE,
  direction = "wide",
  max_pages = 1,
  count = 5
)

print("Clean data columns:")
print(names(clean_ads))
```

## API Parameters

The `li_query()` function supports all parameters from the [LinkedIn Ad Library API](https://www.linkedin.com/ad-library/api/ads):

| Parameter | Type | Description | Example |
|-----------|------|-------------|---------|
| `keyword` | String | Keywords to search in ad content (AND logic) | `"data science"` |
| `advertiser` | String | Advertiser name to search | `"Microsoft"` |
| `countries` | Character vector | 2-letter ISO country codes | `c("us", "gb", "de")` |
| `start_date` | Date/String | Start date (inclusive) | `"2024-01-01"` |
| `end_date` | Date/String | End date (exclusive) | `"2024-12-31"` |
| `count` | Integer | Results per page (max 25) | `25` |
| `max_pages` | Integer | Maximum pages to retrieve | `10` |
| `clean` | Logical | Return simplified data without list-columns | `TRUE` |
| `direction` | String | When clean=TRUE: "wide" or "long" format | `"wide"` |

## Data Structure

The function returns a tibble with the following columns:

```{r data-structure}
# View the structure of returned data
str(marketing_ads)

# Key columns include:
# - ad_url: Direct link to ad preview
# - advertiser_name: Name of the advertiser
# - ad_type: Type of advertisement
# - first_impression_at, latest_impression_at: Date ranges
# - total_impressions_from, total_impressions_to: Impression ranges
# - impressions_by_country: List-column with country breakdown
# - ad_targeting: List-column with targeting criteria
```

## Advanced Examples

### Search with Multiple Criteria

```{r advanced-search}
# Complex search combining multiple parameters
tech_ads <- li_query(
  keyword = "artificial intelligence machine learning",
  countries = c("us", "gb", "de", "fr"),
  start_date = "2024-01-01",
  end_date = "2024-06-30",
  max_pages = 10
)

print(paste("Found", nrow(tech_ads), "AI/ML ads"))
```

### Analyzing Targeting Data

LinkedIn ads include targeting information showing how advertisers segment their audience:

```{r targeting-setup}
# Get ads with targeting data
ads_with_targeting <- li_query(
  countries = c("us"),
  max_pages = 2,
  count = 10
)
```

Extract and analyze the targeting information:

```{r targeting-analysis}
library(dplyr)
library(tidyr)

# Unnest targeting data for analysis
targeting_data <- ads_with_targeting |>
  tidyr::unnest(ad_targeting) |>
  dplyr::filter(!is.na(facet_name))

print(paste("Found targeting data for", nrow(targeting_data), "targeting criteria"))
```

Summarize the most common targeting approaches:

```{r targeting-summary}
if (nrow(targeting_data) > 0) {
  targeting_summary <- targeting_data |>
    dplyr::count(facet_name, sort = TRUE)
  
  print("Most common targeting criteria:")
  print(targeting_summary)
} else {
  print("No targeting data found for this query")
}
```

### Geographic Impression Analysis

When available, impression data shows how ads perform across different countries:

```{r impression-analysis}
# Look for geographic impression data
impression_data <- ads_with_targeting |>
  tidyr::unnest(impressions_by_country) |>
  dplyr::filter(!is.na(country))

print(paste("Found impression data for", nrow(impression_data), "country distributions"))
```

Analyze the geographic distribution:

```{r impression-summary}
if (nrow(impression_data) > 0) {
  country_summary <- impression_data |>
    dplyr::group_by(country) |>
    dplyr::summarise(
      avg_impression_pct = mean(impression_percentage, na.rm = TRUE),
      .groups = "drop"
    ) |>
    dplyr::arrange(desc(avg_impression_pct))
  
  print("Top countries by impression percentage:")
  print(country_summary)
} else {
  print("No geographic impression data found for this query")
}
```

### Clean Data Format Options

The `clean = TRUE` parameter simplifies the data structure for easier analysis:

```{r clean-wide-demo}
# Wide format: countries become separate columns, targeting flattened
clean_wide <- li_query(
  countries = c("us"),
  clean = TRUE,
  direction = "wide",
  max_pages = 1,
  count = 5
)

print("Clean wide format columns:")
print(names(clean_wide))
print(paste("Dimensions:", nrow(clean_wide), "x", ncol(clean_wide)))
```

Notice the key improvements in wide format:
- `impressions_mid`: Calculated midpoint of impression ranges
- `targeting_facets`: Summary of targeting approaches
- Country columns (when data available): `impression_pct_US`, `impression_pct_CA`, etc.

```{r clean-long-demo}
# Long format: all targeting/impression data stacked with type indicators
clean_long <- li_query(
  countries = c("us"),
  clean = TRUE,
  direction = "long",
  max_pages = 1,
  count = 5
)

print("Clean long format columns:")
print(names(clean_long))
print(paste("Dimensions:", nrow(clean_long), "x", ncol(clean_long)))
```

Long format makes comparative analysis easy:

```{r clean-long-analysis}
if (nrow(clean_long) > 0 && "data_type" %in% names(clean_long)) {
  # Count different types of data available
  data_summary <- clean_long |>
    dplyr::count(data_type, sort = TRUE)
  
  print("Data types found:")
  print(data_summary)
} else {
  print("No extended data available for this query")
}
```

## Data Format Options

| Format | Description | Use Case |
|--------|-------------|----------|
| **Raw** (`clean = FALSE`) | List-columns preserved | Advanced analysis, full data access |
| **Clean Wide** (`clean = TRUE, direction = "wide"`) | Targeting/impression data as separate columns | Simple analysis, CSV export |
| **Clean Long** (`clean = TRUE, direction = "long"`) | Targeting/impression data stacked with type indicators | Comparative analysis across ad types |

## Rate Limits and Best Practices

- **Maximum 25 results per request** (API limitation)
- **Use pagination** for large datasets with `max_pages` parameter
- **Specific searches** may return fewer results than broad searches
- **Date ranges**: start is inclusive, end is exclusive
- **Keywords**: Multiple keywords use AND logic
- **Countries**: Use lowercase 2-letter ISO codes

## Authentication Details

The package uses OAuth 2.0 with automatic token caching:

1. **Setup**: `li_auth_configure()` stores app credentials in `.Renviron`
2. **Authentication**: `li_auth()` opens browser for user consent
3. **Token Storage**: Tokens are cached in `.httr-oauth` for reuse
4. **Automatic Refresh**: Tokens are automatically refreshed when needed

## API Reference

Full API documentation is available at: https://www.linkedin.com/ad-library/api/ads

## Contributing

Please report bugs and feature requests at: https://github.com/favstats/liads/issues

## License

MIT License. See `LICENSE` file for details.

---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  eval = FALSE
)
```

# adlibr <img src="man/figures/logo.png" align="right" width="120"/>

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/adlibr)](https://CRAN.R-project.org/package=adlibr)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/favstats/adlibr/workflows/R-CMD-check/badge.svg)](https://github.com/favstats/adlibr/actions)
<!-- badges: end -->

> âš ï¸ **WORK IN PROGRESS**: This package is currently under heavy development and barely works. Many features are incomplete, APIs may change, and functionality is limited. Use at your own risk and expect breaking changes.

**adlibr** is a unified R client for accessing ad library APIs across major digital platforms. It provides a consistent interface for retrieving, analyzing, and comparing advertising data from Meta (Facebook/Instagram), TikTok, Microsoft (Bing), Apple App Store, Google (BigQuery datasets), and other platforms supporting ad transparency initiatives.

## Features

- **ğŸ”€ Unified Interface**: Single API for multiple ad library platforms
- **ğŸ” Secure Authentication**: OAuth 2.0, API keys, and secure credential storage
- **ğŸ“Š Data Normalization**: Common schema across all platforms for easy comparison
- **âš¡ Automatic Pagination**: Handles platform-specific pagination automatically
- **ğŸ›¡ï¸ Rate Limiting**: Built-in retry logic with exponential backoff
- **ğŸ¯ Flexible Filtering**: Search by keywords, advertisers, countries, dates, and more
- **ğŸ“ˆ Rich Metadata**: Targeting criteria, spend ranges, impressions, and creative assets

## Supported Platforms

| Platform | Status | Authentication | Coverage |
|----------|--------|----------------|----------|
| **Meta** (Facebook/Instagram) | ğŸ”§ In Development| Graph API Token | Global (political), EU/UK (all ads) |
| **TikTok** | ğŸ”§ In Development| OAuth 2.0 | EU, expanding globally |
| **Microsoft** (Bing) | ğŸ”§ In Development| Optional API Key | EU/EEA |
| **Apple** App Store | ğŸ”§ In Development| Public API | Global |
| **Google** (BigQuery) | ğŸ”§ In Development| GCP Service Account | Political ads |
| **Amazon** | ğŸ”§ In Development | OAuth 2.0 | EU |
| **Pinterest** | ğŸ“‹ Planned | API Key | EU (DSA) |
| **Snapchat** | ğŸ“‹ Planned | API Key | EU, Global (political) |
| **X** (Twitter) | âš ï¸ Limited | API Key | Limited compliance |

## Installation

You can install the development version of adlibr from [GitHub](https://github.com/favstats/adlibr) with:

``` r
# install.packages("devtools")
devtools::install_github("favstats/adlibr")
```

## Quick Start

### 1. Authentication Setup

Configure credentials for the platforms you want to use:

```{r setup, eval = F}
library(adlibr)

# Interactive setup for all platforms
adlibr_auth_setup()

# Or setup specific platforms
adlibr_auth_setup(c("meta", "tiktok"))

# Check authentication status
adlibr_auth_status()
```

```{r, eval = FALSE, include = FALSE}
devtools::load_all()
library(dplyr)
library(tidyr)
```

### 2. Basic Usage

```{r basic-search}
# Search Meta ads for climate change content
meta_ads <- adlibr_search("meta", 
                         q = "climate change",
                         countries = c("US", "CA"),
                         date_from = "2024-01-01",
                         limit = 50)
```

### 3. Cross-Platform Searching

```{r cross-platform}
# Search across multiple platforms
platforms <- c("meta", "tiktok", "microsoft")
election_ads <- purrr::map_df(platforms, ~{
  adlibr_search(.x, q = "election", countries = "US", limit = 10)
})

# Compare ad volumes by platform
election_ads %>% 
  count(platform, sort = TRUE)
```

### 4. Advertiser and Detailed Searches

```{r advertiser-search2}
# Find advertisers on TikTok
tiktok_advertisers <- adlibr_advertisers("tiktok", q = "tech company")

# Get detailed information for specific ads
ad_details <- adlibr_details("meta", c("ad_id_1", "ad_id_2"))
```

## Unified Data Schema

All platforms return data in a consistent format:

```{r data-structure}
# Common columns across all platforms:
colnames(meta_ads)
```

Key fields include:
- `ad_id`: Platform-specific identifier
- `platform`: Source platform
- `advertiser_name`: Organization name
- `first_seen`/`last_seen`: Date ranges
- `ad_text`: Advertisement content
- `media_type` & `media_urls`: Creative assets
- `countries`: Geographic targeting
- `targeting_*`: Audience targeting criteria
- `extra_json`: Raw platform-specific data

## Unified API Parameters

All `adlibr_*` functions support consistent parameters across platforms:

| Parameter | Type | Description | Example |
|-----------|------|-------------|---------|
| `platform` | String | Platform to query | `"meta"`, `"tiktok"`, `"microsoft"` |
| `q` | String | Keywords to search in ad content | `"climate change"` |
| `advertisers` | Character vector | Advertiser names or IDs | `c("Microsoft", "Google")` |
| `countries` | Character vector | ISO 3166-1 alpha-2 country codes | `c("US", "GB", "DE")` |
| `date_from` | Date/String | Start date (YYYY-MM-DD) | `"2024-01-01"` |
| `date_to` | Date/String | End date (YYYY-MM-DD) | `"2024-12-31"` |
| `types` | Character vector | Platform-specific ad types | Platform dependent |
| `languages` | Character vector | ISO 639-1 language codes | `c("en", "es", "fr")` |
| `limit` | Integer | Results per page (max 1000) | `100` |
| `page_token` | String | Pagination token for next page | From previous response |

## Data Structure

The function returns a tibble with the following columns:

```{r data-fields}
# Key columns include:
# - ad_url: Direct link to ad preview
# - advertiser_name: Name of the advertiser
# - ad_type: Type of advertisement
# - first_impression_at, latest_impression_at: Date ranges
# - total_impressions_from, total_impressions_to: Impression ranges
# - impressions_by_country: List-column with country breakdown
# - ad_targeting: List-column with targeting criteria
```

## Advanced Examples

### How LinkedIn Ad Search Works

LinkedIn's Ad Library API searches through ad content using specific rules:

**Keyword Search**: When you provide multiple keywords, they are treated with **logical AND operation**. This means ALL keywords must appear in the ad content.

```{r search-explanation}
# This searches for ads containing BOTH "artificial" AND "intelligence" AND "machine" AND "learning"
tech_ads <- adlibr_search("linkedin",
  q = "artificial intelligence machine learning",
  countries = c("us", "gb"),
  date_from = "2025-01-01", 
  date_to = "2025-01-31",
  limit = 50
)

tech_ads
```

**Advertiser Search**: You can also search by the company/organization that paid for the ads:

```{r advertiser-search}
# Find all ads paid for by companies with "Microsoft" in their name
microsoft_ads <- adlibr_search("linkedin",
  advertisers = "Microsoft",
  countries = c("us"),
  limit = 10
)

microsoft_ads
```

### Analyzing Targeting Data

LinkedIn ads include targeting information, but **interpretation requires caution**. The API shows what segments advertisers *claim* to target, but doesn't reveal much **targeting precision**. Does "Education" mean university graduates or current students? What is meant by "Job"? What job? This information should really be included but alas it is not.

```{r targeting-analysis}

# Unnest targeting data for analysis
targeting_data <- tech_ads |>
  tidyr::unnest(ad_targeting) |>
  dplyr::filter(!is.na(facet_name))

print(paste("Found targeting data for", nrow(targeting_data), "targeting criteria"))

# Show the top targeting categories
top_targeting <- targeting_data %>% 
  count(facet_name, sort = TRUE)

print("Most common targeting approaches:")
head(top_targeting, 5)
```


### Geographic Impression Analysis

```{r impression-analysis2}
# Look for geographic impression data
impression_data <- tech_ads |>
  tidyr::unnest(impressions_by_country) |>
  dplyr::filter(!is.na(country))


# Visualize top countries only (limit to avoid clutter)
library(ggplot2)
  
# Get top 5 countries by total impression volume
top_countries <- impression_data %>% 
  mutate(impression_per_country = total_impressions_to * (impression_percentage/100)) %>% 
  group_by(country) %>% 
  summarise(
    total_ads = n(),
    sum_impressions = sum(impression_per_country, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(sum_impressions)) %>%
  slice_head(n = 5)

print("Top 5 countries by number of ads:")
print(top_countries)
```


```{r impression-analysis}
# Visualize impression distribution for top countries only
impression_data %>%
  filter(country %in% top_countries$country) %>%
  group_by(country) %>%
  mutate(impression_per_country = total_impressions_to * (impression_percentage / 100)) %>%
  group_by(country) %>%
  summarise(
    total_ads = n(),
    sum_impressions = sum(impression_per_country, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = country, y = sum_impressions)) +
  geom_col() +
  labs(
    title = "Impression Percentage Distribution by Country",
    subtitle = "Top 5 countries by ad volume",
    x = "Country",
    y = "Impression Percentage"
  ) +
  theme_minimal()
```



### Clean Data Format Options

The `clean = TRUE` parameter simplifies the data structure for easier analysis:

```{r clean-wide-demo}
# Wide format: countries become separate columns, targeting flattened
clean_wide <- adlibr_search("linkedin",
  countries = c("us"),
  date_from = "2025-01-01", 
  date_to = "2025-01-31",
  limit = 5
)

clean_wide
```

Notice the key improvements in wide format:
- `impressions_mid`: Calculated midpoint of impression ranges
- `targeting_facets`: Summary of targeting approaches
- Country columns (when data available): `impression_pct_US`, `impression_pct_CA`, etc.

```{r clean-long-demo}
# Long format: all targeting/impression data stacked with type indicators
clean_long <- adlibr_search("linkedin",
  countries = c("fr"),
  date_from = "2025-01-01", 
  date_to = "2025-01-31",
  limit = 5
)

clean_long
```


## Data Format Options

| Format | Description | Use Case |
|--------|-------------|----------|
| **Raw** (`clean = FALSE`) | List-columns preserved | Advanced analysis, full data access |
| **Clean Wide** (`clean = TRUE, direction = "wide"`) | Targeting/impression data as separate columns | Simple analysis, CSV export |
| **Clean Long** (`clean = TRUE, direction = "long"`) | Targeting/impression data stacked with type indicators | Comparative analysis across ad types |

## Rate Limits and Best Practices

- **Maximum 25 results per request** (API limitation)
- **Daily rate limits** applied per application and per member
- **Automatic retry handling**: 429 errors trigger exponential backoff (2, 4, 8 seconds)
- **Use pagination** for large datasets with `max_pages` parameter
- **Specific searches** may return fewer results than broad searches
- **Date ranges**: start is inclusive, end is exclusive
- **Keywords**: Multiple keywords use AND logic
- **Countries**: Use lowercase 2-letter ISO codes

âš ï¸ **Rate Limiting Behavior**: If you exceed LinkedIn's rate limits, the package automatically waits and retries up to 3 times with increasing delays. This ensures your queries succeed even during high-usage periods.

## Authentication Details

The package uses OAuth 2.0 with automatic token caching:

1. **Setup**: `adlibr_auth_setup()` guides you through credential configuration  
2. **Authentication**: Opens browser for user consent when needed
3. **Token Storage**: Credentials are securely stored in environment variables
4. **Automatic Refresh**: Tokens are automatically refreshed when needed

## API Reference

Full API documentation is available at: https://www.linkedin.com/ad-library/api/ads

## Advanced Usage

### Bulk Data Collection

```{r bulk-collection, eval = FALSE}
# Get all available data with automatic pagination
all_election_ads <- adlibr_get_all("meta", "search_ads", 
                                  list(q = "election", countries = "US"),
                                  max_pages = 10, delay = 2)
```

### Platform-Specific Features

```{r platform-features, eval = FALSE}
# Check what platforms are available
adlibr_platforms()

# Check authentication status
adlibr_auth_status()

# Platform-specific targeting analysis
meta_targeting <- meta_ads %>%
  filter(!map_lgl(targeting_age, is.null)) %>%
  unnest(targeting_age)
```

## Research Applications

**adlibr** is designed for researchers studying:

- ğŸ“Š **Digital campaigning** across platforms
- ğŸ¯ **Advertising targeting** practices 
- ğŸŒ **Cross-platform content analysis**
- ğŸ“ˆ **Ad spending transparency**
- ğŸ” **Disinformation research**
- ğŸ“± **Platform policy compliance**

## Rate Limits & Best Practices

- **Respect rate limits**: Each platform has different limits
- **Use delays**: Add delays between requests for large datasets
- **Cache responses**: Save results to avoid re-querying
- **Batch efficiently**: Use appropriate `limit` parameters
- **Monitor usage**: Check authentication status regularly

## Contributing

We welcome contributions! Please see our [Contributing Guide](CONTRIBUTING.md) for details.

- ğŸ› **Bug reports**: https://github.com/favstats/adlibr/issues
- ğŸ’¡ **Feature requests**: https://github.com/favstats/adlibr/discussions
- ğŸ”§ **Pull requests**: Welcome for bug fixes and new features

## Citation

If you use adlibr in your research, please cite:

```bibtex
@software{adlibr,
  title = {adlibr: Unified R Client for Ad Library APIs},
  author = {Fabio Votta},
  url = {https://github.com/favstats/adlibr},
  year = {2024}
}
```

## License

MIT License. See `LICENSE` file for details.

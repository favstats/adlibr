---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  eval = T
)
```

# liads

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/liads)](https://CRAN.R-project.org/package=liads)
[![Lifecycle: stable](https://img.shields.io/badge/lifecycle-stable-brightgreen.svg)](https://lifecycle.r-lib.org/articles/stages.html#stable)
<!-- badges: end -->

**liads** is a comprehensive R client for the [LinkedIn Ad Library API](https://www.linkedin.com/ad-library/api/ads). It provides tools for OAuth 2.0 authentication, querying ads by various criteria, automatic pagination, and robust data processing.

## Installation

You can install the development version of liads from [GitHub](https://github.com/favstats/liads) with:

``` r
# install.packages("devtools")
devtools::install_github("favstats/liads")
```

## Quick Start

### 1. Authentication Setup

First, set up your LinkedIn Developer App credentials (one-time setup):

```{r setup, eval = F}
library(liads)

# Configure your LinkedIn app credentials
li_auth_configure()  # You'll be prompted to enter Client ID and Secret

# Authenticate (opens browser for OAuth)
li_auth()
```

```{r, eval = T, include = FALSE}
devtools::load_all()
library(dplyr)
library(tidyr)

```


### 2. Basic Usage

```{r basic-search}
# Simple keyword search
marketing_ads <- li_query(
  keyword = "marketing",
  max_pages = 1
)
```

The most basic search uses just a keyword. This returns raw data with list-columns for detailed analysis:

```{r basic-results}
marketing_ads
```

### Searching by Country

For more targeted results, search within specific countries:

```{r country-search}
us_ads <- li_query(
  countries = c("us"),
  max_pages = 2,
  count = 10
)

us_ads
```

## How Search Works

**Important**: LinkedIn's Ad Library searches are based on the [official API documentation](https://www.linkedin.com/ad-library/api/ads):

- **Keywords**: Multiple keywords use **AND logic** - ALL keywords must appear in the ad content
- **Countries**: Only shows ads that were actually served in those countries  
- **Dates**: Filters by when ads were served (not when they were created)
- **Advertiser**: Searches company names that paid for the ads

## API Parameters

The `li_query()` function supports all parameters from the LinkedIn Ad Library API:

| Parameter | Type | Description | Example |
|-----------|------|-------------|---------|
| `keyword` | String | Keywords to search in ad content (AND logic) | `"data science"` |
| `advertiser` | String | Advertiser name to search | `"Microsoft"` |
| `countries` | Character vector | 2-letter ISO country codes | `c("us", "gb", "de")` |
| `start_date` | Date/String | Start date (inclusive) | `"2024-01-01"` |
| `end_date` | Date/String | End date (exclusive) | `"2024-12-31"` |
| `count` | Integer | Results per page (max 25) | `25` |
| `max_pages` | Integer | Maximum pages to retrieve | `10` |
| `clean` | Logical | Return simplified data without list-columns | `TRUE` |
| `direction` | String | When clean=TRUE: "wide" or "long" format | `"wide"` |

## Data Structure

The function returns a tibble with the following columns:

```{r data-structure}
# Key columns include:
# - ad_url: Direct link to ad preview
# - advertiser_name: Name of the advertiser
# - ad_type: Type of advertisement
# - first_impression_at, latest_impression_at: Date ranges
# - total_impressions_from, total_impressions_to: Impression ranges
# - impressions_by_country: List-column with country breakdown
# - ad_targeting: List-column with targeting criteria
```

## Advanced Examples

### How LinkedIn Ad Search Works

LinkedIn's Ad Library API searches through ad content using specific rules:

**Keyword Search**: When you provide multiple keywords, they are treated with **logical AND operation**. This means ALL keywords must appear in the ad content.

```{r search-explanation}
# This searches for ads containing BOTH "artificial" AND "intelligence" AND "machine" AND "learning"
tech_ads <- li_query(
  keyword = "artificial intelligence machine learning",
  countries = c("us", "gb"),
  start_date = "2025-01-01", 
  end_date = "2025-01-31",
  max_pages = 2
)

tech_ads
```

**Advertiser Search**: You can also search by the company/organization that paid for the ads:

```{r advertiser-search}
# Find all ads paid for by companies with "Microsoft" in their name
microsoft_ads <- li_query(
  advertiser = "Microsoft",
  countries = c("us"),
  max_pages = 1,
  count = 10
)

microsoft_ads
```

### Analyzing Targeting Data

LinkedIn ads include targeting information, but **interpretation requires caution**. The API shows what segments advertisers *claim* to target, but doesn't reveal much **targeting precision**. Does "Education" mean university graduates or current students? What is meant by "Job"? What job? This information should really be included but alas it is not.

```{r targeting-analysis}

# Unnest targeting data for analysis
targeting_data <- tech_ads |>
  tidyr::unnest(ad_targeting) |>
  dplyr::filter(!is.na(facet_name))

print(paste("Found targeting data for", nrow(targeting_data), "targeting criteria"))

# Show the top targeting categories
top_targeting <- targeting_data %>% 
  count(facet_name, sort = TRUE)

print("Most common targeting approaches:")
head(top_targeting, 5)
```


### Geographic Impression Analysis

```{r impression-analysis2}
# Look for geographic impression data
impression_data <- tech_ads |>
  tidyr::unnest(impressions_by_country) |>
  dplyr::filter(!is.na(country))


# Visualize top countries only (limit to avoid clutter)
library(ggplot2)
  
# Get top 5 countries by total impression volume
top_countries <- impression_data %>% 
  mutate(impression_per_country = total_impressions_to * (impression_percentage/100)) %>% 
  group_by(country) %>% 
  summarise(
    total_ads = n(),
    sum_impressions = sum(impression_per_country, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(sum_impressions)) %>%
  slice_head(n = 5)

print("Top 5 countries by number of ads:")
print(top_countries)
```


```{r impression-analysis}
# Visualize impression distribution for top countries only
impression_data %>%
  filter(country %in% top_countries$country) %>%
  group_by(country) %>%
  mutate(impression_per_country = total_impressions_to * (impression_percentage / 100)) %>%
  group_by(country) %>%
  summarise(
    total_ads = n(),
    sum_impressions = sum(impression_per_country, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = country, y = sum_impressions)) +
  geom_col() +
  labs(
    title = "Impression Percentage Distribution by Country",
    subtitle = "Top 5 countries by ad volume",
    x = "Country",
    y = "Impression Percentage"
  ) +
  theme_minimal()
```



### Clean Data Format Options

The `clean = TRUE` parameter simplifies the data structure for easier analysis:

```{r clean-wide-demo}
# Wide format: countries become separate columns, targeting flattened
clean_wide <- li_query(
  countries = c("us"),
  start_date = "2025-01-01", 
  end_date = "2025-01-31",
  clean = TRUE,
  direction = "wide",
  max_pages = 1,
  count = 5
)

clean_wide
```

Notice the key improvements in wide format:
- `impressions_mid`: Calculated midpoint of impression ranges
- `targeting_facets`: Summary of targeting approaches
- Country columns (when data available): `impression_pct_US`, `impression_pct_CA`, etc.

```{r clean-long-demo}
# Long format: all targeting/impression data stacked with type indicators
clean_long <- li_query(
  countries = c("fr"),
  start_date = "2025-01-01", 
  end_date = "2025-01-31",
  clean = TRUE,
  direction = "long",
  max_pages = 1,
  count = 5
)

clean_long
```


## Data Format Options

| Format | Description | Use Case |
|--------|-------------|----------|
| **Raw** (`clean = FALSE`) | List-columns preserved | Advanced analysis, full data access |
| **Clean Wide** (`clean = TRUE, direction = "wide"`) | Targeting/impression data as separate columns | Simple analysis, CSV export |
| **Clean Long** (`clean = TRUE, direction = "long"`) | Targeting/impression data stacked with type indicators | Comparative analysis across ad types |

## Rate Limits and Best Practices

- **Maximum 25 results per request** (API limitation)
- **Use pagination** for large datasets with `max_pages` parameter
- **Specific searches** may return fewer results than broad searches
- **Date ranges**: start is inclusive, end is exclusive
- **Keywords**: Multiple keywords use AND logic
- **Countries**: Use lowercase 2-letter ISO codes

## Authentication Details

The package uses OAuth 2.0 with automatic token caching:

1. **Setup**: `li_auth_configure()` stores app credentials in `.Renviron`
2. **Authentication**: `li_auth()` opens browser for user consent
3. **Token Storage**: Tokens are cached in `.httr-oauth` for reuse
4. **Automatic Refresh**: Tokens are automatically refreshed when needed

## API Reference

Full API documentation is available at: https://www.linkedin.com/ad-library/api/ads

## Contributing

Please report bugs and feature requests at: https://github.com/favstats/liads/issues

## License

MIT License. See `LICENSE` file for details.
